# Makefile para automaÃ§Ã£o do projeto GitOps
# Este arquivo centraliza todos os comandos necessÃ¡rios para executar o projeto

.PHONY: help create-cluster delete-cluster install-argocd install-ingress deploy-apps clean

# VariÃ¡veis
CLUSTER_NAME=gitops-cluster
ARGOCD_NAMESPACE=argocd
INGRESS_NAMESPACE=ingress-nginx

help: ## Mostra esta mensagem de ajuda
	@echo "Comandos disponÃ­veis:"
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "\033[36m%-20s\033[0m %s\n", $$1, $$2}'

create-cluster: ## Cria o cluster Kubernetes com Kind
	@echo "ğŸš€ Criando cluster Kubernetes com Kind..."
	kind create cluster --config infrastructure/kind/cluster-config.yaml --name $(CLUSTER_NAME)
	@echo "âœ… Cluster criado com sucesso!"
	kubectl cluster-info --context kind-$(CLUSTER_NAME)

delete-cluster: ## Remove o cluster Kubernetes
	@echo "ğŸ—‘ï¸ Removendo cluster..."
	kind delete cluster --name $(CLUSTER_NAME)
	@echo "âœ… Cluster removido!"

install-argocd: ## Instala e configura o ArgoCD no cluster
	@echo "ğŸ“¦ Instalando ArgoCD..."
	kubectl create namespace $(ARGOCD_NAMESPACE) --dry-run=client -o yaml | kubectl apply -f -
	kubectl apply -n $(ARGOCD_NAMESPACE) -f https://raw.githubusercontent.com/argoproj/argo-cd/stable/manifests/install.yaml
	@echo "â³ Aguardando ArgoCD ficar pronto..."
	kubectl wait --for=condition=available --timeout=300s deployment/argocd-server -n $(ARGOCD_NAMESPACE)
	@echo "ğŸ”§ Aplicando configuraÃ§Ãµes personalizadas..."
	kubectl apply -f infrastructure/argocd/argocd-config.yaml
	@echo "âœ… ArgoCD instalado e configurado com sucesso!"
	@echo "ğŸ”‘ Para acessar o ArgoCD, execute: make argocd-password"

install-ingress: ## Instala o Nginx Ingress Controller
	@echo "ğŸŒ Instalando Nginx Ingress Controller..."
	kubectl apply -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/main/deploy/static/provider/kind/deploy.yaml
	@echo "â³ Aguardando Ingress Controller ficar pronto..."
	kubectl wait --namespace $(INGRESS_NAMESPACE) --for=condition=ready pod --selector=app.kubernetes.io/component=controller --timeout=90s
	@echo "âœ… Nginx Ingress Controller instalado!"

argocd-password: ## Mostra a senha do ArgoCD
	@echo "ğŸ”‘ Senha do ArgoCD (usuÃ¡rio: admin):"
	@kubectl -n $(ARGOCD_NAMESPACE) get secret argocd-initial-admin-secret -o jsonpath="{.data.password}" | base64 -d && echo

argocd-port-forward: ## Faz port-forward para acessar o ArgoCD
	@echo "ğŸŒ Acessando ArgoCD em https://localhost:8080"
	@echo "ğŸ‘¤ UsuÃ¡rio: admin"
	@echo "ğŸ”‘ Senha: execute 'make argocd-password' para ver a senha"
	kubectl port-forward svc/argocd-server -n $(ARGOCD_NAMESPACE) 8080:443

deploy-apps: ## Deploys das aplicaÃ§Ãµes via ArgoCD
	@echo "ğŸš€ Configurando aplicaÃ§Ãµes no ArgoCD..."
	kubectl apply -f environments/staging/
	kubectl apply -f environments/production/
	@echo "âœ… AplicaÃ§Ãµes configuradas!"

clean: ## Remove tudo e recria o ambiente
	@echo "ğŸ§¹ Limpando ambiente..."
	make delete-cluster
	make create-cluster
	make install-argocd
	make install-ingress
	@echo "âœ… Ambiente limpo e recriado!"

status: ## Mostra o status do cluster
	@echo "ğŸ“Š Status do Cluster:"
	@echo "Nodes:"
	@kubectl get nodes
	@echo "\nNamespaces:"
	@kubectl get namespaces
	@echo "\nPods do ArgoCD:"
	@kubectl get pods -n $(ARGOCD_NAMESPACE)
	@echo "\nServiÃ§os do ArgoCD:"
	@kubectl get svc -n $(ARGOCD_NAMESPACE)

setup-complete: ## ConfiguraÃ§Ã£o completa do ambiente
	@echo "ğŸš€ Configurando ambiente completo..."
	make create-cluster
	make install-argocd
	make install-ingress
	@echo "âœ… Ambiente pronto para uso!"
	@echo "ğŸ’¡ Execute 'make argocd-port-forward' para acessar o ArgoCD"

check-prereqs: ## Verifica prÃ©-requisitos
	@echo "ğŸ” Verificando prÃ©-requisitos..."
	@powershell -ExecutionPolicy Bypass -File check-prerequisites.ps1